# file: .github/workflows/ci.yml
# version: 1.0.0
# guid: e1f2a3b4-c5d6-7890-e456-901234567890

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Validate action.yml
        run: |
          if [ ! -f action.yml ]; then
            echo "Error: action.yml not found"
            exit 1
          fi
          echo "âœ… action.yml validation passed"

  test:
    name: Test Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
        with:
          toolchain: stable

      - name: Create test project
        run: |
          rm -rf test-project
          cargo new test-project
          cd test-project
          cat >> Cargo.toml << 'EOF'

          [profile.release]
          opt-level = 3
          lto = true
          EOF

      - name: Test action execution
        uses: ./
        with:
          rust-version: 'stable'
          manifest-path: './test-project/Cargo.toml'
          crate-token: 'fake-token-for-testing'
          run-tests: 'true'
          run-clippy: 'true'
          check-format: 'false'
          dry-run: 'true'

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@2576378a8e339169678f9939646ee3ee325e845c # v3.1.1
        with:
          file_or_dir: action.yml
